<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StrucCal Pro - Engineer Edition</title>
    
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="StrucCal Pro">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%230f172a'/%3E%3Cpath d='M25 20h50v15H60v30h15v15H25V65h15V35H25z' fill='%233b82f6'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%230f172a'/%3E%3Cpath d='M25 20h50v15H60v30h15v15H25V65h15V35H25z' fill='%233b82f6'/%3E%3C/svg%3E">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Chakra+Petch:wght@400;500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- ÿßŸÑÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ¨ÿØŸäÿØ: ŸÖÿ≥ÿ∑ÿ≠ÿå ŸáÿßÿØÿ¶ÿå Ÿàÿßÿ≠ÿ™ÿ±ÿßŸÅŸä --- */
        :root {
            /* Dark Mode */
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --input-bg: #0f172a;
            
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --status-safe: #10b981;
            --status-dang: #ef4444;
            --status-warn: #f59e0b;
            
            --font-ar: 'Cairo', sans-serif;
            --font-en: 'Inter', sans-serif;
            --font-digit: 'Chakra Petch', monospace;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        [data-theme="light"] {
            /* Light Mode */
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --input-bg: #f1f5f9;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-en);
            min-height: 100vh;
            padding-bottom: 40px;
            transition: background-color 0.3s, color 0.3s;
        }
        [dir="rtl"] body { font-family: var(--font-ar); }

        .container { width: 100%; max-width: 1000px; margin: 0 auto; padding: 20px; }

        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; margin-bottom: 30px; border-bottom: 1px solid var(--border-color);
        }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 1.3rem; color: var(--text-main); font-weight: 700; letter-spacing: -0.5px; }
        .logo svg { color: var(--primary); }
        
        .header-actions { display: flex; gap: 12px; align-items: center; }

        button { font-family: inherit; cursor: pointer; border: none; outline: none; transition: 0.2s; }
        
        .icon-btn {
            background: var(--card-bg); border: 1px solid var(--border-color);
            color: var(--text-main); width: 42px; height: 42px; border-radius: 10px;
            display: flex; justify-content: center; align-items: center; box-shadow: var(--shadow-sm);
        }
        .icon-btn:hover { border-color: var(--primary); color: var(--primary); }

        .lang-wrapper { position: relative; z-index: 50; }
        .lang-btn {
            background: var(--card-bg); border: 1px solid var(--border-color);
            color: var(--text-main); padding: 0 15px; height: 42px; border-radius: 10px;
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem; font-weight: 500;
            box-shadow: var(--shadow-sm);
        }
        .lang-menu {
            position: absolute; top: calc(100% + 8px); right: 0; width: 160px;
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 8px; box-shadow: var(--shadow-md);
            opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s;
        }
        [dir="rtl"] .lang-menu { right: auto; left: 0; }
        .lang-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .lang-option {
            padding: 10px 12px; border-radius: 6px; display: flex; align-items: center; gap: 10px;
            color: var(--text-muted); font-size: 0.9rem; cursor: pointer;
        }
        .lang-option:hover, .lang-option.selected { background: var(--input-bg); color: var(--text-main); font-weight: 600; }

        .main-grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
        @media (min-width: 900px) { .main-grid { grid-template-columns: 1fr 1.2fr; } }

        .panel {
            background: var(--card-bg); border-radius: 16px; padding: 24px;
            border: 1px solid var(--border-color); box-shadow: var(--shadow-md);
        }
        
        .section-title { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 12px; display: block; }

        .type-toggles { display: flex; gap: 10px; margin-bottom: 24px; background: var(--input-bg); padding: 6px; border-radius: 12px; }
        .type-card {
            flex: 1; padding: 10px 5px; border-radius: 8px; text-align: center; cursor: pointer; 
            color: var(--text-muted); transition: 0.2s; font-weight: 600;
        }
        .type-card.active { background: var(--card-bg); color: var(--text-main); box-shadow: var(--shadow-sm); }
        .type-card span { display: block; font-size: 0.65rem; font-weight: 400; margin-top: 4px; opacity: 0.8; }

        .size-selector {
            background: var(--input-bg); border: 1px solid var(--border-color);
            padding: 16px; border-radius: 12px; display: flex; justify-content: space-between;
            align-items: center; cursor: pointer; margin-bottom: 24px; transition: 0.2s;
        }
        .size-selector:hover { border-color: var(--primary); }
        .current-size { font-family: var(--font-digit); font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .current-size span { color: var(--primary); margin-right: 5px; }

        .input-group { margin-bottom: 24px; }
        .flex-row { display: flex; align-items: center; gap: 15px; }
        
        input[type="number"], select {
            background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-main);
            font-family: var(--font-digit); font-size: 1.1rem; padding: 12px; border-radius: 8px; outline: none; transition: 0.2s;
        }
        input[type="number"]:focus, select:focus { border-color: var(--primary); }
        select { font-family: var(--font-en); font-size: 0.95rem; width: 100%; appearance: none; cursor: pointer; }

        input[type=range] { flex: 1; -webkit-appearance: none; background: transparent; height: 40px; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; cursor: pointer;
            background: #fff; border: 3px solid var(--primary); margin-top: -8px; box-shadow: var(--shadow-sm);
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: var(--border-color); border-radius: 3px; }

        .stepper-control {
            display: flex; align-items: center; background: var(--input-bg);
            border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;
            width: 140px; height: 46px;
        }
        .stepper-btn {
            background: transparent; color: var(--text-main); width: 40px; height: 100%;
            font-size: 1.2rem; display: flex; justify-content: center; align-items: center;
        }
        .stepper-btn:hover { background: var(--border-color); }
        .stepper-control input {
            flex: 1; border: none; background: transparent; text-align: center;
            font-size: 1.2rem; padding: 0; border-radius: 0; box-shadow: none !important;
        }

        .canvas-container {
            width: 100%; height: 240px; background: var(--input-bg);
            border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); margin-bottom: 20px;
        }
        @media (min-width: 768px) { .canvas-container { height: 300px; } }

        .result-display {
            background: var(--input-bg); border-radius: 12px; padding: 24px;
            border: 1px solid var(--border-color); text-align: center;
        }
        .weight-value {
            font-family: var(--font-digit); font-weight: 700; color: var(--text-main);
            font-size: clamp(3rem, 8vw, 4.5rem); line-height: 1.1; margin: 10px 0;
        }
        .weight-unit { font-size: 1.2rem; color: var(--text-muted); font-weight: 600; }
        
        .action-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .btn {
            padding: 14px; border-radius: 10px; font-size: 0.95rem; font-weight: 600;
            display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: var(--input-bg); color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }

        .side-panel {
            position: fixed; top: 0; right: -380px; width: 350px; height: 100%;
            background: var(--card-bg); z-index: 1000; padding: 24px;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 1px solid var(--border-color); display: flex; flex-direction: column;
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
        }
        [dir="rtl"] .side-panel { right: auto; left: -380px; border-left: none; border-right: 1px solid var(--border-color); box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
        .side-panel.open { right: 0; }
        [dir="rtl"] .side-panel.open { left: 0; }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .history-list { flex: 1; overflow-y: auto; padding-right: 5px; }
        .history-item {
            background: var(--input-bg); padding: 15px; border-radius: 10px;
            margin-bottom: 12px; border: 1px solid var(--border-color);
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 2000;
            display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--card-bg); width: 90%; max-width: 500px; border-radius: 16px;
            border: 1px solid var(--border-color); padding: 24px; transform: scale(0.95); transition: 0.3s;
            box-shadow: var(--shadow-md); max-height: 85vh; display: flex; flex-direction: column;
        }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .modal-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 10px;
            overflow-y: auto; padding-right: 5px; margin-top: 15px;
        }
        .size-badge {
            background: var(--input-bg); padding: 12px 5px; text-align: center; border: 1px solid transparent;
            border-radius: 8px; font-family: var(--font-digit); cursor: pointer; color: var(--text-main); transition: 0.2s;
        }
        .size-badge:hover, .size-badge.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        @media print {
            body { background: #fff; color: #000; }
            header, .panel, .action-bar, .side-panel, .modal-overlay { display: none !important; }
            .container { max-width: 100%; padding: 0; }
            .main-grid { display: block; }
            .result-display { border: 2px solid #000; background: #fff; color: #000; box-shadow: none; margin-top: 20px; }
            .weight-value { color: #000 !important; }
            #printHeader { display: block !important; text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px; }
            #printImg { display: block !important; margin: 0 auto 20px auto; max-width: 70%; border: 1px solid #ccc; }
        }
        #printHeader, #printImg { display: none; }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div class="side-panel" id="historyPanel">
        <div class="panel-header">
            <h3 style="color:var(--text-main); font-weight: 600;" data-i18n="projectList">Project List</h3>
            <button onclick="toggleHistory(false)" style="background:none; color:var(--text-muted); font-size:1.5rem;">&times;</button>
        </div>
        <div class="history-list" id="historyList">
            <div style="text-align:center; color:var(--text-muted); padding-top:20px;">List is empty</div>
        </div>
        <button class="btn btn-secondary" id="printBtn" style="margin-top: 15px;">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6z"></path></svg>
            <span data-i18n="print">Print Report</span>
        </button>
    </div>

    <div id="sizeModal" class="modal-overlay">
        <div class="modal-content">
            <div class="panel-header" style="margin-bottom: 0;">
                <h3 style="color:var(--text-main); font-size: 1.1rem;" data-i18n="selectSize">Select Size</h3>
                <button id="closeModalBtn" style="background:none; color:var(--text-muted); font-size:1.5rem;">&times;</button>
            </div>
            <div class="modal-grid" id="modalSizeGrid"></div>
        </div>
    </div>

    <div id="printHeader">
        <h1>StrucCal Pro Report</h1>
        <p>Engineering Steel Weight Calculation</p>
        <p id="printDate"></p>
    </div>
    <img id="printImg" src="" alt="3D View">

    <div class="container">
        <header>
            <div class="logo">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M4 18h16M12 6v12" /></svg>
                <span>StrucCal Pro</span>
            </div>
            
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleTheme()" id="themeBtn" title="Toggle Theme">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
                <div class="lang-wrapper">
                    <button class="lang-btn" onclick="toggleLangMenu(event)">
                        <span id="currentLangLabel">üá∫üá∏ EN</span>
                    </button>
                    <div class="lang-menu" id="langMenu">
                        <div class="lang-option selected" onclick="selectLang('en')">üá∫üá∏ English</div>
                        <div class="lang-option" onclick="selectLang('ar')">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</div>
                        <div class="lang-option" onclick="selectLang('de')">üá©üá™ Deutsch</div>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-grid">
            <div class="panel">
                <div class="type-toggles">
                    <div class="type-card active" data-type="HEA">HEA <span data-i18n="light">Light</span></div>
                    <div class="type-card" data-type="HEB">HEB <span data-i18n="standard">Standard</span></div>
                    <div class="type-card" data-type="HEM">HEM <span data-i18n="heavy">Heavy</span></div>
                </div>

                <div class="size-selector" id="openModalBtn">
                    <div>
                        <span class="section-title" data-i18n="selectSize" style="margin-bottom: 4px;">Profile Size</span>
                        <div class="current-size"><span id="displayType">HEA</span><span id="displaySize" style="color:var(--text-main)">100</span></div>
                    </div>
                    <svg width="20" height="20" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"></path></svg>
                </div>

                <div class="input-group">
                    <span class="section-title" data-i18n="enterLength">Length (mm)</span>
                    <div class="flex-row">
                        <input type="range" id="lengthRange" min="100" max="12000" step="100" value="1000">
                        <input type="number" id="lengthInput" value="1000" min="100" max="12000" style="width: 90px; text-align: center;">
                    </div>
                </div>

                <div class="input-group">
                    <span class="section-title" data-i18n="quantity">Quantity (Pieces)</span>
                    <div class="stepper-control">
                        <button class="stepper-btn" id="btnMinus">-</button>
                        <input type="number" id="qtyInput" value="1" min="1" max="1000">
                        <button class="stepper-btn" id="btnPlus">+</button>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 0;">
                    <span class="section-title" data-i18n="coating">Coating Material</span>
                    <div style="position: relative;">
                        <select id="coatingSelect">
                            <option value="standard" data-i18n="standardCoating">Standard Steel (Raw)</option>
                            <option value="galvanized" data-i18n="galvanized">Hot-Dip Galvanized</option>
                            <option value="fireproof" data-i18n="fireproof">Fireproof Paint (Red)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="panel right-panel">
                <div class="canvas-container">
                    <div id="webgl-canvas" style="width:100%; height:100%;"></div>
                </div>

                <div class="result-display" id="mainScreen">
                    <span class="section-title" data-i18n="totalWeight">Total Calculated Weight</span>
                    <div class="weight-value" id="animatedWeight">0.00</div>
                    <div class="weight-unit" id="unitDisplay">KG</div>
                </div>

                <div class="action-bar">
                    <button class="btn btn-primary" id="addBomBtn">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
                        <span data-i18n="addToList">Add to List</span>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleHistory(true)">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                        <span data-i18n="projectListBtn">Open List</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- DATA (ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØŸÇŸäŸÇÿ© ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÇÿßÿ≥ÿßÿ™) ---
        const steelDatabase = {
            'HEA': { 100: {h:96,b:100,tw:5,tf:8,w:16.7}, 120: {h:114,b:120,tw:5,tf:8,w:19.9}, 140: {h:133,b:140,tw:5.5,tf:8.5,w:24.7}, 160: {h:152,b:160,tw:6,tf:9,w:30.4}, 180: {h:171,b:180,tw:6,tf:9.5,w:35.5}, 200: {h:190,b:200,tw:6.5,tf:10,w:42.3}, 220: {h:210,b:220,tw:7,tf:11,w:50.5}, 240: {h:230,b:240,tw:7.5,tf:12,w:60.3}, 260: {h:250,b:260,tw:7.5,tf:12.5,w:68.2}, 280: {h:270,b:280,tw:8,tf:13,w:76.4}, 300: {h:290,b:300,tw:8.5,tf:14,w:88.3}, 320: {h:310,b:300,tw:9,tf:15.5,w:97.6}, 340: {h:330,b:300,tw:9.5,tf:16.5,w:105}, 360: {h:350,b:300,tw:10,tf:17.5,w:112}, 400: {h:390,b:300,tw:11,tf:19,w:125}, 450: {h:440,b:300,tw:11.5,tf:21,w:140}, 500: {h:490,b:300,tw:12,tf:23,w:155}, 550: {h:540,b:300,tw:12.5,tf:24,w:166}, 600: {h:590,b:300,tw:13,tf:25,w:178}, 650: {h:640,b:300,tw:13.5,tf:26,w:190}, 700: {h:690,b:300,tw:14.5,tf:27,w:204}, 800: {h:790,b:300,tw:15,tf:28,w:224}, 900: {h:890,b:300,tw:16,tf:30,w:252}, 1000: {h:990,b:300,tw:16.5,tf:31,w:272} },
            
            'HEB': { 100: {h:100,b:100,tw:6,tf:10,w:20.4}, 120: {h:120,b:120,tw:6.5,tf:11,w:26.7}, 140: {h:140,b:140,tw:7,tf:12,w:33.7}, 160: {h:160,b:160,tw:8,tf:13,w:42.6}, 180: {h:180,b:180,tw:8.5,tf:14,w:51.2}, 200: {h:200,b:200,tw:9,tf:15,w:61.3}, 220: {h:220,b:220,tw:9.5,tf:16,w:71.5}, 240: {h:240,b:240,tw:10,tf:17,w:83.2}, 260: {h:260,b:260,tw:10,tf:17.5,w:93.0}, 280: {h:280,b:280,tw:10.5,tf:18,w:103}, 300: {h:300,b:300,tw:11,tf:19,w:117}, 320: {h:320,b:300,tw:11.5,tf:20.5,w:127}, 340: {h:340,b:300,tw:12,tf:21.5,w:134}, 360: {h:360,b:300,tw:12.5,tf:22.5,w:142}, 400: {h:400,b:300,tw:13.5,tf:24,w:155}, 450: {h:450,b:300,tw:14,tf:26,w:171}, 500: {h:500,b:300,tw:14.5,tf:28,w:187}, 550: {h:550,b:300,tw:15,tf:29,w:199}, 600: {h:600,b:300,tw:15.5,tf:30,w:212}, 650: {h:650,b:300,tw:16,tf:31,w:225}, 700: {h:700,b:300,tw:17,tf:32,w:241}, 800: {h:800,b:300,tw:17.5,tf:33,w:262}, 900: {h:900,b:300,tw:18.5,tf:35,w:291}, 1000: {h:1000,b:300,tw:19,tf:36,w:314} },
            
            'HEM': { 100: {h:120,b:106,tw:12,tf:20,w:41.8}, 120: {h:140,b:126,tw:12.5,tf:21,w:52.1}, 140: {h:160,b:146,tw:13,tf:22,w:63.2}, 160: {h:180,b:166,tw:14,tf:23,w:76.2}, 180: {h:200,b:186,tw:14.5,tf:24,w:88.9}, 200: {h:220,b:206,tw:15,tf:25,w:103}, 220: {h:240,b:226,tw:15.5,tf:26,w:117}, 240: {h:270,b:248,tw:18,tf:32,w:157}, 260: {h:290,b:268,tw:18,tf:32.5,w:172}, 280: {h:310,b:288,tw:18.5,tf:33,w:189}, 300: {h:340,b:310,tw:21,tf:39,w:238}, 320: {h:359,b:309,tw:21,tf:40,w:245}, 340: {h:377,b:309,tw:21,tf:40,w:248}, 360: {h:395,b:308,tw:21,tf:40,w:250}, 400: {h:432,b:307,tw:21,tf:40,w:256}, 450: {h:478,b:307,tw:21,tf:40,w:263}, 500: {h:524,b:306,tw:21,tf:40,w:270}, 550: {h:572,b:306,tw:21,tf:40,w:278}, 600: {h:620,b:305,tw:21,tf:40,w:285}, 650: {h:668,b:305,tw:21,tf:40,w:293}, 700: {h:716,b:304,tw:21,tf:40,w:301}, 800: {h:814,b:303,tw:21,tf:40,w:317}, 900: {h:910,b:302,tw:21,tf:40,w:333}, 1000: {h:1008,b:302,tw:21,tf:40,w:349} }
        };

        const translations = {
            en: { 
                light:"Light", standard:"Standard", heavy:"Heavy", enterLength:"Length (mm)", quantity:"Quantity (Pieces)",
                selectSize:"Profile Size", totalWeight:"Total Calculated Weight", print:"Print Report", 
                coating:"Coating Material", standardCoating:"Standard Steel (Raw)", galvanized:"Hot-Dip Galvanized", 
                fireproof:"Fireproof Paint (Red)", addToList:"Add to List", projectListBtn:"Open List", projectList:"Project List"
            },
            ar: { 
                light:"ÿÆŸÅŸäŸÅ", standard:"ŸÇŸäÿßÿ≥Ÿä", heavy:"ÿ´ŸÇŸäŸÑ", enterLength:"ÿßŸÑÿ∑ŸàŸÑ (ŸÖŸÖ)", quantity:"ÿßŸÑÿπÿØÿØ (ŸÇÿ∑ÿπ)",
                selectSize:"ŸÖŸÇÿßÿ≥ ÿßŸÑŸÖŸÇÿ∑ÿπ", totalWeight:"ÿßŸÑŸàÿ≤ŸÜ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ÿ≥Ÿàÿ®", print:"ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±", 
                coating:"ŸÖÿßÿØÿ© ÿßŸÑÿ∑ŸÑÿßÿ°", standardCoating:"ŸÅŸàŸÑÿßÿ∞ ŸÇŸäÿßÿ≥Ÿä (ÿÆÿßŸÖ)", galvanized:"ŸÖÿ¨ŸÑ⁄§ŸÜ ÿ®ÿßŸÑÿ∫ŸÖÿ≥ ÿßŸÑÿ≥ÿßÿÆŸÜ", 
                fireproof:"ÿØŸáÿßŸÜ ŸÖŸÇÿßŸàŸÖ ŸÑŸÑÿ≠ÿ±ŸäŸÇ (ÿ£ÿ≠ŸÖÿ±)", addToList:"ÿ£ÿ∂ŸÅ ŸÑŸÑŸÇÿßÿ¶ŸÖÿ©", projectListBtn:"ÿßŸÅÿ™ÿ≠ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©", projectList:"ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ"
            },
            de: {
                light:"Leicht", standard:"Standard", heavy:"Schwer", enterLength:"L√§nge (mm)", quantity:"Menge (St√ºck)",
                selectSize:"Profilgr√∂√üe", totalWeight:"Gesamtberechnetes Gewicht", print:"Bericht drucken", 
                coating:"Beschichtungsmaterial", standardCoating:"Standardstahl (Roh)", galvanized:"Feuerverzinkt", 
                fireproof:"Feuerfeste Farbe (Rot)", addToList:"Zur Liste hinzuf√ºgen", projectListBtn:"Liste √∂ffnen", projectList:"Projektliste"
            }
        };

        let state = { lang: 'en', type: 'HEA', size: 100, length: 1000, quantity: 1, currentDisplayedWeight: 0, theme: 'dark', coating: 'standard' };
        let projectBOM = [];
        let scene, camera, renderer, mesh, controls, animationFrameId;

        init();
        function init() {
            init3D();
            setupEvents();
            renderModalGrid();
            calculateAndAnimate();
            updateBOMUI();
        }

        window.toggleTheme = () => {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', state.theme);
            const color = state.theme === 'dark' ? 0x0f172a : 0xf8fafc;
            renderer.setClearColor(color, 1);
        };

        window.toggleLangMenu = (e) => {
            e.stopPropagation();
            document.getElementById('langMenu').classList.toggle('show');
        };

        window.selectLang = (code) => {
            state.lang = code;
            document.documentElement.dir = (code === 'ar') ? 'rtl' : 'ltr';
            const t = translations[code];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });

            const flags = { en: 'üá∫üá∏', ar: 'üá∏üá¶', de: 'üá©üá™' };
            const labels = { en: 'EN', ar: 'AR', de: 'DE' };
            document.getElementById('currentLangLabel').innerHTML = `${flags[code]} ${labels[code]}`;
            document.getElementById('langMenu').classList.remove('show');
            document.querySelectorAll('.lang-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`.lang-option[onclick="selectLang('${code}')"]`).classList.add('selected');
        };

        window.toggleHistory = (show) => {
            const p = document.getElementById('historyPanel');
            if(show) p.classList.add('open'); else p.classList.remove('open');
        };

        window.addEventListener('click', () => {
            const menu = document.getElementById('langMenu');
            if(menu) menu.classList.remove('show');
        });

        function setupEvents() {
            document.querySelectorAll('.type-card').forEach(card => {
                card.addEventListener('click', () => setProfileType(card.getAttribute('data-type')));
            });

            const lInput = document.getElementById('lengthInput');
            const lRange = document.getElementById('lengthRange');
            lInput.addEventListener('input', (e) => updateLength(e.target.value));
            lRange.addEventListener('input', (e) => updateLength(e.target.value));

            // Stepper (Quantity)
            const qtyInput = document.getElementById('qtyInput');
            const btnMinus = document.getElementById('btnMinus');
            const btnPlus = document.getElementById('btnPlus');

            const updateQty = (val) => {
                let newVal = parseInt(val);
                if (isNaN(newVal) || newVal < 1) newVal = 1;
                qtyInput.value = newVal;
                state.quantity = newVal;
                calculateAndAnimate();
            };

            qtyInput.addEventListener('change', (e) => updateQty(e.target.value));
            btnMinus.addEventListener('click', () => updateQty(state.quantity - 1));
            btnPlus.addEventListener('click', () => updateQty(state.quantity + 1));

            document.getElementById('coatingSelect').addEventListener('change', (e) => {
                state.coating = e.target.value;
                update3D();
            });

            document.getElementById('openModalBtn').addEventListener('click', () => toggleModal(true));
            document.getElementById('closeModalBtn').addEventListener('click', () => toggleModal(false));
            document.getElementById('sizeModal').addEventListener('click', (e) => { if(e.target.id === 'sizeModal') toggleModal(false); });

            document.getElementById('addBomBtn').addEventListener('click', addToBOM);
            document.getElementById('printBtn').addEventListener('click', printReport);
        }
        // --- LOGIC (ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®Ÿäÿ© ŸàÿßŸÑŸàÿßÿ¨Ÿáÿ©) ---
        function setProfileType(type) {
            state.type = type;
            document.getElementById('displayType').textContent = type;
            document.querySelectorAll('.type-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`.type-card[data-type="${type}"]`).classList.add('active');
            
            state.size = 100;
            document.getElementById('displaySize').textContent = 100;
            renderModalGrid();
            calculateAndAnimate();
            update3D();
        }

        function updateLength(val) {
            state.length = parseInt(val);
            document.getElementById('lengthInput').value = state.length;
            document.getElementById('lengthRange').value = state.length;
            calculateAndAnimate();
            update3DGeometryLength();
        }

        function calculateAndAnimate() {
            const data = steelDatabase[state.type][state.size];
            if (!data) return;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸàÿ≤ŸÜ = (ÿßŸÑÿ∑ŸàŸÑ ÿ®ÿßŸÑŸÖÿ™ÿ± √ó ÿßŸÑŸàÿ≤ŸÜ ŸÑŸÑŸÖÿ™ÿ± ÿßŸÑÿ∑ŸàŸÑŸä) √ó ÿßŸÑÿπÿØÿØ
            const trueWeightKg = ((state.length / 1000) * data.w) * state.quantity;
            
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            const startVal = state.currentDisplayedWeight;
            const diff = trueWeightKg - startVal;
            const startTime = performance.now();
            const duration = 400;

            function update(time) {
                const elapsed = time - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3);
                const current = startVal + (diff * ease);
                
                state.currentDisplayedWeight = current;
                renderResult(current);

                if (progress < 1) animationFrameId = requestAnimationFrame(update);
            }
            animationFrameId = requestAnimationFrame(update);
        }

        function renderResult(val) {
            const displayEl = document.getElementById('animatedWeight');
            const unitEl = document.getElementById('unitDisplay');
            
            if (val >= 1000) {
                displayEl.textContent = (val / 1000).toFixed(3);
                unitEl.textContent = "TON";
                displayEl.style.color = "var(--status-dang)";
            } else {
                displayEl.textContent = val.toFixed(2);
                unitEl.textContent = "KG";
                displayEl.style.color = val >= 500 ? "var(--status-warn)" : "var(--status-safe)";
            }
        }

        function toggleModal(show) {
            const m = document.getElementById('sizeModal');
            if(show) m.classList.add('open'); else m.classList.remove('open');
        }

        function renderModalGrid() {
            const grid = document.getElementById('modalSizeGrid');
            grid.innerHTML = '';
            const sizes = Object.keys(steelDatabase[state.type]);
            sizes.forEach(s => {
                const item = document.createElement('div');
                item.className = `size-badge ${s == state.size ? 'active' : ''}`;
                item.textContent = s;
                item.onclick = () => {
                    state.size = s;
                    document.getElementById('displaySize').textContent = s;
                    toggleModal(false);
                    calculateAndAnimate();
                    update3D();
                };
                grid.appendChild(item);
            });
        }

        // --- BOM (BILL OF MATERIALS) LOGIC ---
        function addToBOM() {
            const data = steelDatabase[state.type][state.size];
            if (!data) return;
            
            const singleWeight = (state.length / 1000) * data.w;
            const totalWeight = singleWeight * state.quantity;
            
            projectBOM.push({
                type: state.type,
                size: state.size,
                length: state.length,
                quantity: state.quantity,
                coating: state.coating,
                weight: totalWeight
            });

            updateBOMUI();
            
            const btn = document.getElementById('addBomBtn');
            const origHTML = btn.innerHTML;
            btn.innerHTML = `‚úÖ Added`;
            btn.style.backgroundColor = "var(--status-safe)";
            setTimeout(() => {
                btn.innerHTML = origHTML;
                btn.style.backgroundColor = "";
            }, 1000);
        }

        function updateBOMUI() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            
            if(projectBOM.length === 0) {
                list.innerHTML = `<div style="text-align:center;color:var(--text-muted);padding:20px;">List is empty</div>`;
                return;
            }

            let totalProjectWeight = 0;

            projectBOM.forEach((item, index) => {
                totalProjectWeight += item.weight;
                const el = document.createElement('div');
                el.className = 'history-item';
                el.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="display:block; font-weight: 600; color: var(--text-main); font-size: 0.95rem;">
                                ${item.type} ${item.size} <span style="color:var(--text-muted); font-weight:400;">(${item.length}mm)</span>
                            </span>
                            <span style="font-size:0.8rem; color:var(--primary); font-weight: 600;">x${item.quantity} Pieces</span>
                            <span style="font-size:0.75rem; color:var(--text-muted); margin-left:8px;">${item.coating}</span>
                        </div>
                        <div style="text-align:right;">
                            <span style="color:var(--text-main); display:block; font-weight: 700; font-family:var(--font-digit);">${item.weight.toFixed(2)} KG</span>
                            <button onclick="removeFromBOM(${index})" style="background:none; border:none; color:var(--status-dang); cursor:pointer; font-size:0.8rem; margin-top: 5px; font-weight:500;">Remove</button>
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });

            const totalEl = document.createElement('div');
            totalEl.style.cssText = "margin-top:20px; padding:20px; background:var(--card-bg); border:1px solid var(--primary); border-radius:10px; text-align:center; box-shadow: var(--shadow-md);";
            
            const isTon = totalProjectWeight >= 1000;
            const finalWeightText = isTon ? (totalProjectWeight/1000).toFixed(3) + ' TON' : totalProjectWeight.toFixed(2) + ' KG';
            
            totalEl.innerHTML = `
                <span style="color:var(--text-muted); font-size:0.85rem; display:block; text-transform:uppercase; font-weight:600; margin-bottom:5px;">Total Project Weight</span>
                <strong style="color:var(--primary); font-size:1.8rem; font-family:var(--font-digit);">${finalWeightText}</strong>
            `;
            list.appendChild(totalEl);
        }

        window.removeFromBOM = function(index) {
            projectBOM.splice(index, 1);
            updateBOMUI();
        };

        function printReport() {
            const imgData = renderer.domElement.toDataURL("image/png");
            document.getElementById('printImg').src = imgData;
            document.getElementById('printDate').innerText = new Date().toLocaleString();
            window.print();
        }

        // --- THREE.JS (ŸÖÿ≠ÿ±ŸÉ ÿßŸÑŸÄ 3D) ---
        function init3D() {
            const container = document.getElementById('webgl-canvas');
            const w = container.offsetWidth;
            const h = container.offsetHeight;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, w/h, 0.1, 1000);
            camera.position.set(18, 14, 18);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
            renderer.setSize(w, h);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setClearColor(state.theme === 'dark' ? 0x0f172a : 0xf8fafc, 1);
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.enablePan = false;

            const al = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(al);
            const dl = new THREE.DirectionalLight(0xffffff, 1.2); dl.position.set(10, 20, 10); scene.add(dl);
            const bl = new THREE.DirectionalLight(0x3b82f6, 0.8); bl.position.set(-10, 5, -5); scene.add(bl);
            
            const grid = new THREE.GridHelper(50, 50, 0x334155, 0x1e293b);
            grid.position.y = -5;
            scene.add(grid);

            update3D();
            
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
            
            window.addEventListener('resize', () => {
                const nw = container.offsetWidth;
                const nh = container.offsetHeight;
                camera.aspect = nw/nh;
                camera.updateProjectionMatrix();
                renderer.setSize(nw, nh);
            });
        }

        function update3D() {
            if (mesh) { scene.remove(mesh); mesh.geometry.dispose(); mesh.material.dispose(); }
            const data = steelDatabase[state.type][state.size];
            if(!data) return;
            const s = 0.04; 
            
            const shape = new THREE.Shape();
            const H = data.h * s, B = data.b * s, TW = data.tw * s, TF = data.tf * s;
            shape.moveTo(-B/2, H/2); shape.lineTo(B/2, H/2); shape.lineTo(B/2, H/2 - TF); 
            shape.lineTo(TW/2, H/2 - TF); shape.lineTo(TW/2, -H/2 + TF); shape.lineTo(B/2, -H/2 + TF); 
            shape.lineTo(B/2, -H/2); shape.lineTo(-B/2, -H/2); shape.lineTo(-B/2, -H/2 + TF);
            shape.lineTo(-TW/2, -H/2 + TF); shape.lineTo(-TW/2, H/2 - TF); shape.lineTo(-B/2, H/2 - TF);
            shape.lineTo(-B/2, H/2);

            const visualLen = (state.length / 1000) * 3.5; 
            const geo = new THREE.ExtrudeGeometry(shape, { steps: 1, depth: visualLen, bevelEnabled: false });
            geo.center();
            
            let matColor = 0x475569; 
            let matMetalness = 0.5;
            let matRoughness = 0.5;

            if (state.coating === 'galvanized') {
                matColor = 0xe2e8f0; 
                matMetalness = 0.9;
                matRoughness = 0.2;
            } else if (state.coating === 'fireproof') {
                matColor = 0xef4444; 
                matMetalness = 0.1;
                matRoughness = 0.9;
            }

            const mat = new THREE.MeshStandardMaterial({ 
                color: matColor, 
                metalness: matMetalness, 
                roughness: matRoughness 
            });

            mesh = new THREE.Mesh(geo, mat);
            mesh.rotation.y = Math.PI / 2;
            mesh.position.y = (data.h * s) / 2;
            scene.add(mesh);
        }

        function update3DGeometryLength() { update3D(); }
    </script>
</body>
</html>
